{% extends "base.html" %}

{% load bootstrap_toolkit %}
{% load crispy_forms_tags %}

{% block title %}Modify Order{% endblock %}

{% block page_title %}Modify Order {{order}}{% endblock page_title %}

{% block extra_js %}
<script type="text/javascript">
    $(function() {
      $(document).ready(function() {
        
        $('#tabs a').click(function (e) {
          e.preventDefault();
          $(this).tab('show');
        })

        /*$("#order-items-fieldset div.items-form").filter(':not .processed').each(function() {
          $form = $(this);
          $form.addClass('processed');
          var in_stock = $form.find('input.order-item-in-stock').prop('checked');
          console.log('stock_status' + in_stock);
        });*/
        
        // items formset
        $("#order-items-fieldset").find("div.accordion-body").eq(0).addClass("in"); //expand first item
        $('#order-items-fieldset div.items-form').formset({
            prefix: '{{items_form.prefix}}',
            added: function($form) {
              var accordions = $form.parent().find('div.accordion-group');
              var form_ind = accordions.length - 1;
              $form.find("div.accordion-heading a.accordion-toggle").attr("href", "#collapseordered_items-" + form_ind).text("Item " + (form_ind + 1));
              $form.find("div.accordion-body").attr("id", "collapseordered_items-" + form_ind);
              $("#order-items-fieldset").find("div.accordion-body").removeClass("in");
              $form.find("div.accordion-heading a").click();
            }
        });

        // commissions formset
        $("#order-commissions-fieldset").find("div.accordion-body:first").addClass("in"); //expand first item
        $('#order-commissions-fieldset div.commissions-form').formset({
            prefix: '{{commissions_form.prefix}}',
            added: function($form) {
              var accordions = $form.parent().find('div.accordion-group');
              var form_ind = accordions.length - 1;
              $form.find("div.accordion-heading a.accordion-toggle").attr("href", "#collapsecommissions-" + form_ind).text("Commissions " + (form_ind + 1));
              $form.find("div.accordion-body").attr("id", "collapsecommissions-" + form_ind);
              $("#order-commissions-fieldset").find("div.accordion-body").removeClass("in");
              $form.find("div.accordion-heading a").click();
            }
        });
      });
    })
</script>

  {{ form.media }}
  {{ items_form.media }}
  {{ commissions_form.media }}
  {{ delivery_form.media }}
  
{% endblock %}

{% block extra_css %}
<style type="text/css">
    .delete-row {
        margin-left:5px;
    }   
</style>
{% endblock %}

{% block content %}

<form action="" method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.non_field_errors }} 
  
  <div class="tabbable tabs-left">
  
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="tabs">
      <li class="active"><a href="#order-info" data-toggle="tab">Order info</a></li>
      <li><a href="#customer-info" data-toggle="tab">Customer</a></li>
      <li><a href="#payment-info" data-toggle="tab">Payment</a></li>
      <li><a href="#order-items-fieldset" data-toggle="tab">Items</a></li>
      <li><a href="#deliveries" data-toggle="tab">Deliveries</a></li>
      <li><a href="#order-commissions-fieldset" data-toggle="tab">Commissions</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">  
      <div class="tab-pane active" id="order-info">
        <fieldset>
          <legend>Order info</legend>
      
           <div class="field-wrapper inline">
             {{ form.number.errors }}
             <label for="id_number">Order #</label>
             {{ form.number }}
           </div>
           <div class="field-wrapper inline">
             {{ form.created.errors }}
             {{ form.created | as_bootstrap }}
           </div>
           <div class="field-wrapper inline">
             {{ form.status.errors }}
             <label for="id_status">Status</label>
             {{ form.status }}
           </div>
      
           <div class="field-wrapper clear">
             {{ form.store.errors }}
             <label for="id_store">Store</label>
             {{ form.store }}
           </div>
      
        </fieldset>
      </div>
    
      <div class="tab-pane" id="customer-info">
        <fieldset>
          <legend>Customer Info</legend>
          <div class="customer-selection">
            <h5>Select existing or create a customer</h5>
            <div class="field-wrapper">
              {{ form.customer.errors }}
              <label for="id_customer">Customer</label>
              {{ form.customer }}
            </div>
            <div id="new-customer-form-wrapper" >
              {{ customer_form.management_form }}
              {% for subform in customer_form %}
                <div class="accordion-group items-form form-row" id="{{ customer_form.prefix }}-row">
                  <div class="accordion-heading">
                    <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#new-customer-form-wrapper" href="#collapse{{ customer_form.prefix }}">
                      New Customer
                    </a>
                  </div>
                  <div id="collapse{{ customer_form.prefix }}" class="accordion-body collapse">
                    <div class="accordion-inner">
                      {{ subform.non_field_errors }}
                      {{ subform }}
                    </div>
                  </div>       
                </div>
              {% endfor %}
            </div>
            <div id="referral-info">
              <label for="id_referral">Referral source</label>
              {{ form.referral }} 
            </div>
          </div>
        </fieldset>
      </div>
    
      <div class="tab-pane" id="payment-info">
        <fieldset>
          <legend>Payment Information</legend>
          <div class="field-wrapper">
            {{ form.subtotal_after_discount.errors }}
            <label for="id_subtotal_after_discount">Subtotal After Discount</label>
            {{ form.subtotal_after_discount }}
          </div>
          <div class="field-wrapper">
            {{ form.deposit_balance.errors }}
            <label for="id_deposit_balance">Deposit Balance</label>
            {{ form.deposit_balance }}
          </div>
          <div class="field-wrapper">
            {{ form.tax.errors }}
            <label for="id_tax">Tax</label>
            {{ form.tax }}
          </div>
          <div class="field-wrapper">
            {{ form.shipping.errors }}
            <label for="id_shipping">Shipping</label>
            {{ form.shipping }}
          </div>
        </fieldset>
      </div>
      
      <div class="tab-pane" id="order-items-fieldset">
        <fieldset class="accordion">
          <legend>Sold Items</legend>
          {{ items_form.management_form }}
          {{ items_form.non_field_errors }}    
          {% for item_form in items_form %}
            <div class="accordion-group items-form form-row" id="{{ item_form.prefix }}-row">
              <div class="accordion-heading">
                <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#order-items-fieldset" href="#collapse{{ item_form.prefix }}">
                 Item {{ forloop.counter }}
                </a>
              </div>
              <div id="collapse{{ item_form.prefix }}" class="accordion-body collapse">
                <div class="accordion-inner">
                  {% comment %} {{ item_form | as_bootstrap }} {% endcomment %}
                  {% crispy item_form %}
                </div>
              </div>       
            </div>
          {% endfor %}
        </fieldset>
      </div>
    
      <div class="tab-pane" id="deliveries">
        <fieldset class="formset">
          <legend>Deliveries</legend>
          {{ delivery_form.management_form }}
          {% if delivery_form %}
            {{ delivery_form.non_form_errors }}
            {% for form in delivery_form %}
              <div class="form-row inline">
                {{ form | as_bootstrap}}
              </div>
            {% endfor %}
          {% else %}
            No deliveries are available.
          {% endif %}
        </fieldset>
      </div>
    
      <div class="tab-pane" id="order-commissions-fieldset">
        <fieldset class="formset accordion">
          <legend>Commissions</legend>
          {{ commissions_form.management_form }}
          {% if commissions_form %}
            {{ commissions_form.non_field_errors }}    
            {% for comm_form in commissions_form %}
              <div class="accordion-group commissions-form form-row" id="{{ commissions_form.prefix }}-{{forloop.counter}}-row">
                <div class="accordion-heading">
                  <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#order-commissions-fieldset" href="#collapse{{ commissions_form.prefix }}">
                   Commissions {{ forloop.counter }}
                  </a>
                </div>
                <div id="collapse{{ commissions_form.prefix }}" class="accordion-body collapse">
                  <div class="accordion-inner">
                    {{ comm_form | as_bootstrap }}
                  </div>
                </div>       
              </div>
            {% endfor %}
          {% else %}
              No commissions info available.
          {% endif %}

        </fieldset>
      </div>
    
    </div>
  
  </div>

  <div class="field-wrapper">
    {{ form.comments.errors }}
    <label for="id_comments">Comments</label>
    {{ form.comments }}
  </div>

  <input type="submit" value="Save"/>

</form>

{% endblock content %}
