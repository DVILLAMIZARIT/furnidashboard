{% extends "base.html" %}

{% load bootstrap_toolkit %}

{% block title %}Modify Order{% endblock %}

{% block page_title %}Modify Order {{order}}{% endblock page_title %}

{% block extra_js %}
<script type="text/javascript">
    $(function() {
      $(document).ready(function() {
        
        $("#order-items-fieldset").find("div.accordion-body").eq(0).addClass("in"); //expand first item

        $('#order-items-fieldset div.items-form').formset({
            prefix: '{{items_form.prefix}}',
            added: function($form) {
              var accordions = $form.parent().find('div.accordion-group');
              var form_ind = accordions.length - 1;
              $form.find("div.accordion-heading a.accordion-toggle").attr("href", "#collapseordered_items-" + form_ind).text("Item " + (form_ind + 1));
              $form.find("div.accordion-body").attr("id", "collapseordered_items-" + form_ind);
              $("#order-items-fieldset").find("div.accordion-body").removeClass("in");
              $form.find("div.accordion-heading a").click();
            }
        });
      });
    })
</script>

  {{ form.media }}
  
{% endblock %}

{% block extra_css %}
<style type="text/css">
    .delete-row {
        margin-left:5px;
    }   
</style>
{% endblock %}

{% block content %}

<form action="" method="POST">
  {% csrf_token %}
  {{ form.non_field_errors }} 

  <fieldset id="order-info">
    <legend>Order info</legend>

     <div class="field-wrapper inline">
       {{ form.number.errors }}
       <label for="id_number">Order #</label>
       {{ form.number }}
     </div>
     <div class="field-wrapper inline">
       {{ form.status.errors }}
       <label for="id_status">Status</label>
       {{ form.status }}
     </div>

     <div class="field-wrapper clear">
       {{ form.store.errors }}
       <label for="id_store">Store</label>
       {{ form.store }}
     </div>

  </fieldset>

  <fieldset id="customer-info">
    <legend>Customer Info</legend>
    <div class="customer-selection">
      <h5>Select existing or create a customer</h5>
      <div class="field-wrapper">
        {{ form.customer.errors }}
        <label for="id_customer">Customer</label>
        {{ form.customer }}
      </div>
      <div id="new-customer-form-wrapper" >
        {{ customer_form.management_form }}
        {% for subform in customer_form %}
          <div class="accordion-group items-form form-row" id="{{ customer_form.prefix }}-row">
            <div class="accordion-heading">
              <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#new-customer-form-wrapper" href="#collapse{{ customer_form.prefix }}">
                New Customer
              </a>
            </div>
            <div id="collapse{{ customer_form.prefix }}" class="accordion-body collapse">
              <div class="accordion-inner">
                {{ subform.non_field_errors }}
                {{ subform }}
              </div>
            </div>       
          </div>
        {% endfor %}
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Payment Information</legend>
    <div class="field-wrapper">
      {{ form.subtotal_after_discount.errors }}
      <label for="id_subtotal_after_discount">Subtotal After Discount</label>
      {{ form.subtotal_after_discount }}
    </div>
    <div class="field-wrapper">
      {{ form.deposit_balance.errors }}
      <label for="id_deposit_balance">Deposit Balance</label>
      {{ form.deposit_balance }}
    </div>
    <div class="field-wrapper">
      {{ form.tax.errors }}
      <label for="id_tax">Tax</label>
      {{ form.tax }}
    </div>
    <div class="field-wrapper">
      {{ form.shipping.errors }}
      <label for="id_shipping">Shipping</label>
      {{ form.shipping }}
    </div>
  </fieldset>
  
  <fieldset id="order-items-fieldset" class="accordion">
    <legend>Sold Items</legend>
    {{ items_form.management_form }}
    {{ items_form.non_field_errors }}    
    {% for item_form in items_form %}
      <div class="accordion-group items-form form-row" id="{{ item_form.prefix }}-row">
        <div class="accordion-heading">
          <a class="accordion-toggle collapsed" data-toggle="collapse" data-parent="#order-items-fieldset" href="#collapse{{ item_form.prefix }}">
           Item {{ forloop.counter }}
          </a>
        </div>
        <div id="collapse{{ item_form.prefix }}" class="accordion-body collapse">
          <div class="accordion-inner">
            {{ item_form|as_bootstrap }}
          </div>
        </div>       
      </div>
    {% endfor %}
  </fieldset>

  <div class="field-wrapper">
    {{ form.comments.errors }}
    <label for="id_comments">Comments</label>
    {{ form.comments }}
  </div>


  <fieldset class="formset">
    <legend>Commissions</legend>
    {{ commission_form.management_form }}
    {{ commission_form.non_form_errors }}
    {% for com_form in commission_form %}
      <div class="form-row inline">
        {{ com_form.as_p }}
      </div>
    {% endfor %}
  </fieldset>

  <input type="submit" value="Save"/>

</form>

{% endblock content %}
